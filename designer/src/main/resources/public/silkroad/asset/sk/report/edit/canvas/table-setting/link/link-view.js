define(["dialog","report/edit/canvas/table-setting/link/link-model","report/edit/canvas/table-setting/link/link-template","report/edit/canvas/table-setting/link/link-param-template","report/edit/canvas/table-setting/link/link-operation-column-item-template","report/edit/canvas/table-setting/link/link-param-add-template"],function(a,b,c,d,e){var f=Backbone.View.extend({events:{"click .j-set-link":"dialogLinkSetting"},initialize:function(a){var c=this;c.model=new b({canvasModel:a.canvasView.model,reportId:a.reportId}),this.model.set("compId",this.$el.find(".j-comp-setting").attr("data-comp-id"))},dialogLinkSetting:function(){var a=this;a.model.getColumnLinkPlaneList(function(b){a._openColumnLinkPlaneDialog(b),a.bindEvents()})},bindEvents:function(){var a=this,b=$(".j-table-link-set-column-table .j-next"),c=$(".j-table-link-set-param-table .j-back"),d=$(".j-table-link-set-param-table .j-ok");b.unbind(),c.unbind(),d.unbind(),b.bind("click",function(){a.saveColumnTableRelation($(this))}),c.bind("click",function(){$(".j-table-link-set-first").show(),$(".j-table-link-set-param-table").hide()}),d.bind("click",function(){a.saveParamRelation()}),$(".j-table-link-set-plane-table").unbind(),$(".j-table-link-set-plane-table").change(function(b){a.showSetParamBtn(b)}),a.bindOperationColumnEvents()},bindOperationColumnEvents:function(){function b(){var b=$(".j-table-link-operation-column-items .j-del"),d=$(".j-table-link-normal-items .j-del"),e=$(".j-table-link-operation-column-items .j-next");b.unbind(),d.unbind(),e.unbind(),$(".j-table-link-set-plane-table").unbind(),b.bind("click",function(){var b=$(this);a.confirm("确定删除吗？",function(){if(b.attr("data-status"))b.parent().remove();else{var a=b.parent().find("input").attr("data-value");c.delOperationColumn(a,b.parent())}})}),d.bind("click",function(){var b=$(this);a.confirm("确定清除关联关系吗？",function(){var a=b.parent().find("label").attr("data-value");c.delNormalColumn(a,b)})}),e.bind("click",function(){c.saveColumnTableRelation($(this))}),$(".j-table-link-set-plane-table").change(function(a){c.showSetParamBtn(a)})}var c=this,d=$(".j-table-link-operation-column .j-add"),f=$(".j-table-link-operation-column-items"),g=c.model;d.unbind(),d.bind("click",function(){var a={};a.planeTableList=g.get("planeTableList");var c=g.get("operationColumnId"),d=c.split("_"),h=d[0],i=Number(d[1]);i++,h+="_"+i,g.set("operationColumnId",h),a.operationColumnId=h,f.append(e.render(a)),b()}),b()},showSetParamBtn:function(a){var b=$(a.target);b.val()?b.next().show():b.next().hide()},showParamSetting:function(a){var b=this;b.model.getParamSetList(a,function(a){$(".j-table-link-set-param-items").html(d.render(a))})},saveColumnTableRelation:function(b){var c=this,d={},e=[],f=$(".j-table-link-set-column-table .table-link-set-item"),g=!0;f.each(function(){var a=$(this),b=a.find("label"),c=b.attr("data-value"),d=b.attr("data-text"),f=a.find("select").val();e.push({id:c,selectedTable:f,text:d})}),f=$(".j-table-link-operation-column-items .table-link-set-item");var h=[];if(f.each(function(){var b=$(this),c=b.find("input"),d=c.attr("data-value")||null,f=c.val().trim();if(""===f)return a.alert("请输入正确的名字"),g=!1;if($.isInArray(f,h))return a.alert("操作列名字不能重复"),g=!1;h.push(f);var i=b.find("select").val();e.push({id:d,selectedTable:i,text:f})}),g){d.linkInfo=JSON.stringify(e);var i={};i.planeTableId=b.prev("select").val(),i.olapElementId=b.prev().prev().attr("data-value"),c.olapElementId=i.olapElementId,c.model.saveColumnTableRelation(d,function(){$(".j-table-link-set-first").hide(),$(".j-table-link-set-param-table").show(),c.showParamSetting(i)})}},delOperationColumn:function(a,b){var c=this;c.model.delOperationColumn(a,function(){b&&b.remove()})},delNormalColumn:function(a,b){var c=this;c.model.delOperationColumn(a,function(){b.siblings("select").val(""),b.siblings("span").hide()})},saveParamRelation:function(){var a=this,b=$(".j-table-link-set-param-table .table-link-set-item"),c=[],d={};b.each(function(){var a=$(this),b=a.find("label").attr("data-value"),d=a.find("select").val();c.push({paramName:b,selectedDim:d})}),d.mappingInfo=JSON.stringify(c),d.olapElementId=a.olapElementId,a.model.saveParamRelation(d,function(){a.$dialog.dialog("close");var b=window.dataInsight.main.canvas;b.showReport()})},destroy:function(){this.stopListening(),this.model.clear({silent:!0}),delete this.model,this.$el.unbind()},_openColumnLinkPlaneDialog:function(b){var d,e=this;return $.isEmptyObject(b.columnDefine)?(a.alert("没有指标"),void 0):(d=c.render(b),e.$dialog=a.showDialog({title:"跳转设置",content:d,dialog:{width:440,height:450,resizable:!1}}),void 0)}});return f});