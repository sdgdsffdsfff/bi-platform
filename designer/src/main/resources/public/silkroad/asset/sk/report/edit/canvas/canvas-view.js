define(["template","dialog","report/edit/canvas/canvas-model","report/report-view","report/component-box/main-view","report/edit/canvas/edit-comp-view","report/edit/canvas/edit-btns-template","report/edit/canvas/guides-template","report/global-menu-btns/main-view"],function(a,b,c,d,e,f,g,h,i){return Backbone.View.extend({events:{"click .j-con-edit-btns .j-setting":"initCompConfigBar","click .j-con-edit-btns .j-delete":"deleteComp","click .j-button-save-report":"saveReport","click .j-button-close-report":"closeReport","click .j-button-publish-report":"publishReport","click .j-button-preview-report":"previewReport","click .j-comp-div":"focusText","blur .j-comp-text":"blurText","keydown .j-comp-text":"keyDownText"},savestate:0,initialize:function(a){var b=this;b.globalMenuView=new i({el:b.el,reportId:b.id,canvasView:b}),b.compBoxView=new e({el:b.el,id:b.id,canvasView:b}),this.model=new c({id:b.id,parentModel:a.parentView.model,compBoxModel:b.compBoxView.model}),b.parentView=a.parentView,b.editCompView=new f({el:b.el,reportId:b.id,canvasView:b}),b.reportView=new d({id:b.id}),b.model.getFixReportTaskMgrList(b.id,function(a){b.isFixReport=a,b.model.initJson(function(){b.model.initVm(function(){b.showReport()})})})},initAcceptComp:function(){function a(a,b){for(var c=!1,d=0;d<b.length;d++)b[d].clzKey===a&&(b[d].dataOpt&&"查询"===b[d].dataOpt.text||"DI_REPORTSAVE"===a)&&(c=!0);return c}var c=this,d=c.compBoxView.model,e="active",f="disable",g=c.model.reportJson.entityDefs;$(".j-report",c.el).droppable({accept:".j-con-component-box .j-component-item",tolerance:"intersect",drop:function(e,f){var h=$(this),i=f.helper.attr("data-component-type");if("H_BUTTON"===i||"REPORT_SAVE_COMP"===i){var j="REPORT_SAVE_COMP"===i?"DI_REPORTSAVE":i;if(a(j,g))return b.alert("当前组件只能拖一个"),void 0}if(c.isFixReport){var k=["TABLE","CHART","PLANE_TABLE"];if(!$.isInArray(i,k))return b.alert("固定报表目前只支持表格，平面表，图形组件！"),void 0}var l=f.helper.clone().html('<div class="ta-c">组件占位，配置数据后展示组件</div>'),m=d.getComponentData(i);l.removeClass(m.iconClass+" active"),l.addClass(m.renderClass),l.css({cursor:"auto"}),h.removeClass("active");var n=l.attr("data-default-width");l.css({width:n+"px",height:l.attr("data-default-height")+"px"});var o=parseInt(l.css("left")),p=h.width();o/1+n/1>p&&l.css("left",p-n-3+"px"),parseInt(l.css("left"))<2&&l.css("left","3px"),parseInt(l.css("top"))<2&&l.css("top","3px"),c.addComp(m,i,l)},helper:"clone",out:function(a,b){$(this).removeClass(e),b.helper.removeClass(e).addClass(f),b.helper.html('<div class="ta-c">已超出画布区</div>')},over:function(a,b){$(this).addClass(e),b.helper.removeClass(f).addClass(e),b.helper.html('<div class="ta-c">组件占位，配置数据后展示组件</div>')}})},focusText:function(a){var b="点击进行输入",c=$(a.target),d=c.parent(),e=c,f=d.next(),g=e.html();d.hide(),f.show().focus(),g!=b?f.val(e.html()):f.val("")},blurText:function(a){var b=$(a.target).val(),c=this;c.saveBtnsText(a,b)},keyDownText:function(a){var b=$(a.target).val(),c=this;13==a.keyCode&&c.saveBtnsText(a,b)},saveBtnsText:function(a,b){var c="点击进行输入",d=$(a.target),e=d.prev(),f=e.find("div"),g=f.attr("id");d.hide(),e.show(),""!=b?f.html(b):f.html(c),this.model.dateCompPositing(g,b)},addComp:function(a,c,d){var e=this;e.model.addComp(a,c,function(a,b){return d.attr("data-comp-id",a),d.attr("report-comp-id",b),d.clone()},function(){var a=d.attr("data-component-type");e.$el.find('[data-o_o-di="snpt"]').append(d),e.initDrag(d),e.initResize(d),e.addEditBtns(d),e.removeGuides(d),e.addGuides(d),d.find(".j-con-edit-btns").css({width:"auto",height:"auto"}),("TEXT"===a||"H_BUTTON"===a||"REPORT_SAVE_COMP"===a)&&(e.showReport(!0),"REPORT_SAVE_COMP"===a&&b.alert("报表保存在设计端不能使用"))})},deleteComp:function(a){var b=this,c=$(a.target),d=c.parents(".j-component-item"),e=d.attr("data-comp-id"),f=d.attr("report-comp-id"),g=d.attr("data-component-type");this.model.deleteComp(e,f,g,function(){d.remove(),b.editCompView.hideEditBar(),b.showReport()})},initDrag:function(a){var b=this;a.draggable({helper:"original",scroll:!0,scrollSensitivity:100,containment:this.$el.find(".j-report"),opacity:.8,handle:".j-drag",start:function(a,b){b.helper.attr("data-sort-startScrrolTop",b.helper.parent().scrollTop())},stop:function(a,c){b.updateCompPositing(c.helper),b.initSnptHeight()}})},initResize:function(a){var b=this;a.resizable({stop:function(a,c){var d=c.size;d.compId=$(this).attr("data-comp-id"),b.model.resizeComp(d),b.showReport(!0)}}),a.find(".ui-resizable-e,.ui-resizable-s").remove(),a.filter('[data-component-type="TABLE"]').resizable("option","minHeight",204),b.dragWidthHeight(a,"SELECT",33,33),b.dragWidthHeight(a,"MULTISELECT",33,33),b.dragWidthHeight(a,"REPORT_SAVE_COMP",33,33),b.dragWidthHeight(a,"TEXT",33,33),b.dragWidthHeight(a,"H_BUTTON",33,33,67),b.dragWidthHeight(a,"TIME_COMP",33,33,220),b.dragWidthHeight(a,"SINGLE_DROP_DOWN_TREE",33,33,210,210),b.removeGuides(a),b.addGuides(a)},dragWidthHeight:function(a,b,c,d,e,f){a.filter('[data-component-type="'+b+'"]').resizable("option","minHeight",c),a.filter('[data-component-type="'+b+'"]').resizable("option","maxHeight",d),a.filter('[data-component-type="'+b+'"]').resizable("option","minWidth",e),a.filter('[data-component-type="'+b+'"]').resizable("option","maxWidth",f)},updateCompPositing:function(a){var b=a.attr("data-comp-id"),c=a.css("left"),d=a.css("top");this.model.updateCompPositing(b,c,d)},addGuides:function(a){a.append(h.render())},removeGuides:function(a){a.find(".j-guide-line").remove()},addEditBtns:function(a){a.find(".con-edit-btns").remove(),a.append(g.render()),a.find(".comp-box").css("margin-top",0);for(var b=0;b<a.length;b++){var c=$(a[b]).attr("data-component-type");("TEXT"===c||"H_BUTTON"===c||"REPORT_SAVE_COMP"===c)&&$(a[b]).find(".j-setting").remove()}},saveReport:function(){function a(a,c){var d,e=window.dataInsight.main.id;d='<div class="save-reportNameBox"><div class="save-reportName">'+a+"</div>"+'<input type="text" class="save-reportSetName" value="'+c+'"/></div>',b.showDialog({content:d,title:"保存提示",dialog:{height:200,width:300,open:function(){},buttons:{"确认":function(){$.ajax({type:"POST",dataType:"json",cache:!1,timeout:1e4,url:"reports/"+e+"/name/"+$(".save-reportSetName").val(),success:function(a){0===a.status?b.success(a.statusInfo):b.error(a.statusInfo)}}),$(this).dialog("close")},"取消":function(){$(this).dialog("close")}}}})}var c=this.$el.find(".reportName").text();this.model.saveReport(c,function(){b.success("报表保存成功。")},a),this.savestate=1},closeReport:function(){0==this.savestate?b.warning("您未进行保存，请保存后关闭。"):(this._destroyPanel(),require(["report/list/main-view"],function(a){new a({el:$(".j-main")})}))},_destroyPanel:function(){window.dataInsight&&window.dataInsight.main&&window.dataInsight.main.destroy()},publishReport:function(){0==this.savestate?b.warning("您未进行保存，请保存后发布。"):this.reportView.publishReport("POST")},previewReport:function(){this.reportView.previewReport("POST")},initCompConfigBar:function(a){this.editCompView.initCompConfigBar(a)},initSnptHeight:function(){var a=this.$el.find('[data-o_o-di="snpt"]'),b=200,c=this.$el.find(".report .j-component-item"),d=0;c.each(function(){var a=$(this),b=a.height()+parseInt(a.css("top"));d=b>d?b:d}),a.height(d+b)},destroy:function(){this.model.clear({silent:!0}),this.stopListening(),this.$el.unbind().empty(),this._component&&this._component.dispose()},showReport:function(){var a=this;if(a.model.reportJson.entityDefs.length<2){var b=a.model.$reportVm.prop("outerHTML");return a.$el.find(".j-report").html(b),a.initAcceptComp(),void 0}for(var c={parentEl:a.$el.find(".j-report")[0],reportId:a.id,rptHtml:a.model.$reportVm.prop("outerHTML"),rptJson:$.extend(!0,{},a.model.reportJson)},d=0;d<c.rptJson.entityDefs.length;d++)"DI_REPORTSAVE"===c.rptJson.entityDefs[d].clzKey&&(c.rptJson.entityDefs[d].isInDesigner=!0);a._firstShowReport=!1,void 0===a._component?require(["report/component-combination/enter"],function(b){a._component=b,b.start(c)}):(a._component.dispose(),a._component.start(c)),window.setTimeout(function(){var b=a.$el.find(".j-report"),c=b.find(".j-component-item");a.initDrag(c),a.initResize(c),a.addEditBtns(c),a.initAcceptComp(),a.editCompView.activeComp(),a.initSnptHeight()},2e3)}})});