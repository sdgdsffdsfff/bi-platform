define(["dialog","report/global-menu-btns/fix-report/fix-report-model","report/global-menu-btns/fix-report/fix-report-template","report/global-menu-btns/fix-report/fix-report-set-template","report/global-menu-btns/fix-report/fix-report-task-list-template","common/select-tree/select-tree","url"],function(a,b,c,d,e,f,g){return Backbone.View.extend({events:{"click .j-fix-report":"getFixReportTaskMgrList"},initialize:function(a){this.model=new b({canvasModel:a.canvasView.model,reportId:a.reportId})},getFixReportTaskMgrList:function(){var b=window.dataInsight.main.canvas.savestate;if(0===b)return a.warning("您未进行保存，请先进行保存。"),void 0;var c=this,d=["TABLE","CHART","PLANE_TABLE"],e=$(".j-component-item").filter(".shell-component"),f=!0;return e.each(function(){var a=$(this).attr("data-component-type");return $.isInArray(a,d)?void 0:(f=!1,void 0)}),f?(c.model.getFixReportTaskMgrList(function(a){c.openFixReportDialog(a)}),void 0):(a.alert("固定报表目前只支持表格，平面表，图形组件！"),void 0)},openFixReportDialog:function(b){var d=this,e=c.render(b);d.$dialog=a.showDialog({title:"固定报表",content:e,dialog:{width:650,height:470,resizable:!1}}),d.bindEvent()},bindEvent:function(){var b=this,c=$(".j-operation-btns .j-cancel"),d=$(".j-operation-btns .j-ok");b.bindTaskListEvent(),d.unbind(),d.click(function(){var c,d=$(".j-fix-report-mgr .j-task-id").attr("task-id"),e=$(".j-fix-report-mgr .j-task-id").val();if(e&&(e=e.trim()),!e)return a.alert("请输入合法的任务名称！"),void 0;var f=$(".j-fix-report-mgr .j-isRunNow").is(":checked");if(!f){var g,h,i=$(".j-fix-report-mgr .j-time-hour").val().trim();if(!i)return a.alert("小时不能为空"),void 0;if(g=Number(i),g>24||0>g)return a.alert("请输入合法的时间"),void 0;var j=$(".j-fix-report-mgr .j-time-minute").val().trim();if(!j)return a.alert("分钟不能为空"),void 0;if(h=Number(j),h>60||0>h)return a.alert("请输入合法的时间"),void 0;var k=$(".j-fix-report-mgr .j-granularity-parent").val(),l=$(".j-fix-report-mgr .j-granularity-child").val();c={hour:i,minute:j,granularity:k,detail:l}}var m=[],n=$(".j-param-tree");n.each(function(){var a=$(this).attr("data-param-id"),b=$(this).attr("data-param-name"),c=$(this).attr("data-tree-select-id"),d=$(this).attr("data-tree-select-name"),e=$(this).attr("data-param-caption");m.push({paramId:a,paramName:b,caption:e,paramValue:{id:c,name:d}})});var o={taskId:d,taskName:e,params:JSON.stringify(m),isRunNow:f};!f&&(o.executeStrategy=JSON.stringify(c)),b.saveTaskInfo(o)}),c.unbind(),c.click(function(){b.$dialog.dialog("close")})},bindTaskListEvent:function(){var b=this,c=$(".j-fix-report-mgr .j-task-start"),d=$(".j-fix-report-mgr .j-task-del"),e=$(".j-fix-report-mgr .j-task-add"),f=$(".j-fix-report-mgr .j-task-look"),g=$(".j-fix-report-mgr .j-task-url");c.unbind(),c.click(function(){var a=$(this);if(a.hasClass("j-task-start")){var c=a.parents(".task-item").attr("task-id");a.removeClass("j-task-start biplt-start").addClass("j-task-stop biplt-stop"),b.startTask(c,0)}}),d.unbind(),d.click(function(){var c=$(this),d=c.parents(".task-item").attr("task-id");a.confirm("是否确定删除当前任务",function(){b.delTask(d)})}),e.unbind(),e.click(function(){b.addTask()}),f.unbind(),f.click(function(){var a=$(this),c=a.parents(".task-item").attr("task-id");b.getTaskInfo(c)}),g.unbind(),g.click(function(){var b=$(this),c='<div class="word-bread w-300">'+b.html()+"</div>";a.alert(c)})},startTask:function(a,b){var c=this;c.model.startTask(a,b,function(b){var c=$('[task-id="'+a+'"] td:eq(1) div');c.attr("title",b).html(b)})},delTask:function(a){var b=this;b.model.delTask(a,function(){$('[task-id="'+a+'"]').remove()})},saveTaskInfo:function(a){var b=this;b.model.saveTaskInfo(a,function(){b.model.getFixReportTaskMgrList(function(a){var c=e.render(a);$(".j-fix-report-mgr .j-fix-report-content").html(c),$(".j-fix-report-mgr .j-operation-btns").hide(),b.bindTaskListEvent()})})},getTaskInfo:function(a){var b=this;b.model.getTaskInfo(a,function(c){$(".j-fix-report-content").html(d.render(c)),$(".j-operation-btns").show(),b.taskMgrEvent(a)})},addTask:function(){var a=this,b={taskName:"",isRunNow:!1,executeStrategy:{hour:"",minute:"",granularity:"D"}};a.model.getParamData(null,function(b){$(".j-fix-report-content").html(d.render(b)),$(".j-operation-btns").show(),a.taskMgrEvent()},b)},taskMgrEvent:function(a){var b=this,c=b.model.get("reportId"),d=$(".j-fix-report-mgr .j-isRunNow");d.click(function(){$(this).is(":checked")?$(".j-isRunNow-set").hide():$(".j-isRunNow-set").show()}),$(".j-granularity-parent").change(function(){var a=$(this).val();if("D"===a)return $(".j-granularity-child").html("").hide(),void 0;var c=b.model.get("granularityList").child,d=[];c=c[a];for(var e in c)d.push('<option value="',e,'">',c[e],"</option>");$(".j-granularity-child").html(d.join("")),$(".j-granularity-child").show()});var e=$(".j-fix-report-mgr .j-param-tree");e.each(function(){var d=this,e=$(d).attr("data-param-id"),h=g.getFixReportMgrTree(c,e),i={el:$(d)[0],async:{enable:!0,url:h,autoParam:["id","name"]}};a&&(i.async.otherParam={taskId:a}),b["tree-"+e]=new f(i)});var h=$(".j-fix-report-mgr .j-time-hour"),i=$(".j-fix-report-mgr .j-time-minute");h.unbind(),h.keyup(function(a){var b=$(a.target),c=b.val().trim();return/^\d+$/.test(c)?void 0:(b.val(""),void 0)}),i.unbind(),i.keyup(function(a){var b=$(a.target),c=b.val().trim();return/^\d+$/.test(c)?void 0:(b.val(""),void 0)})},destroy:function(){this.stopListening(),this.model.clear({silent:!0}),delete this.model,this.$el.unbind()}})});