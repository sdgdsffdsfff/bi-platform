define(["url","constant","report/component-box/components/form-config"],function(a,b){var c="snpt.";return Backbone.Model.extend({initialize:function(a){this.parentModel=a.parentModel,this.compBoxModel=a.compBoxModel,window.canvas=this},initJson:function(b){var d=this;$.ajax({url:a.initJson(d.id),success:function(a){if(null!==a.data)d.reportJson=JSON.parse(a.data);else{d.reportJson=$.extend(!0,{},d.compBoxModel.config.defaultJson);var e=d.compBoxModel.config.formModel;d.reportJson.entityDefs.push(e.processRenderData(c))}b(d.reportJson)}})},initVm:function(b){var d=this;$.ajax({url:a.initVm(d.id),success:function(a){if(null!==a.data)d.$reportVm=$(a.data);else{d.$reportVm=$(d.compBoxModel.config.defaultVm);var e=d.compBoxModel.config.formModel;d.$reportVm.append(e.vmTemplate.render({id:c}))}b(d.$reportVm)}})},hasFormComponent:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return!0}return!1},_getFormJson:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return d}return null},addComp:function(b,c,d,e){var f=this;$.ajax({url:a.addComp(f.id),type:"POST",data:{type:c},success:function(a){var g=a.data;f.addCompDataToVm(d,b,c,g),f.addCompDataToJson(b,c,g),f.saveJsonVm(e)}})},addCompDataToVm:function(a,b,d,e){var f=c+e.id,g=a(e.id,f);if(g.html(b.vm.render({rootId:c,serverData:e})),"REPORT_SAVE_COMP"===b.type){var h=g.children()[0];this.$reportVm.prepend(h)}this.$reportVm.append(g)},addCompDataToJson:function(a,b,d){for(var e,f=this.reportJson,g=!1,h=!1,i=f.entityDefs,j=0;j<i.length;j++)"COMPONENT"===i[j].clzType&&"DI_FORM"===i[j].clzType&&i[j].vuiRef&&i[j].vuiRef.confirm&&(h=!0);if(e=a.processRenderData({rootId:c,serverData:d}),h&&e.dataOpt&&(e.dataOpt.submitMode="CONFIRM"),$.isArray(e))for(var j=0,k=e.length;k>j;j++)e[j].compId=d.id;else e.compId=d.id;if(a.entityDescription&&!$.isArray(a.entityDescription)&&"VUI"==a.entityDescription.clzType&&(formJson=this._getFormJson(),"H_BUTTON"===a.entityDescription.clzKey?(formJson.vuiRef.confirm=e.id,g=!0):formJson.vuiRef.input.push(e.id)),g)for(var j=0;j<i.length;j++)"COMPONENT"===i[j].clzType&&i[j].dataOpt&&i[j].dataOpt.submitMode&&(i[j].dataOpt.submitMode="CONFIRM");this.reportJson.entityDefs=i.concat(e)},deleteComp:function(b,c,d,e){var f=this;$.ajax({url:a.deleteComp(f.id,b),type:"DELETE",success:function(){f._deleteComp(b,c,d,e)}})},_deleteComp:function(a,c,d,e){var f=this,g=!1,h=!1;e=e||new Function;var i="[data-comp-id="+a+"]";f.$reportVm.find(i).remove(),"REPORT_SAVE_COMP"===d&&f.$reportVm.children()[0].remove();for(var j=f.reportJson.entityDefs,k=0;k<j.length;k++){if(j[k].compId==a){if("VUI"==j[k].clzType&&$.isInArray(j[k].clzKey,b.FORM_VUI_REF)&&(f._deleteCompFromForm(j[k].id),g=!0),"VUI"==j[k].clzType&&"H_BUTTON"===j[k].clzKey&&j[k].dataOpt&&"查询"===j[k].dataOpt.text){var l=f._getFormJson();l.vuiRef.confirm=null,delete l.vuiRef.confirm,g=!0,h=!0}j.splice(k,1),k--}if("COMPONENT"===j[k].clzType&&j[k].interactions)for(var m=0,n=j[k].interactions.length;n>m;m++){var o=j[k].interactions[m];if(o.event&&o.event.rid===c)j[k].interactions.splice(m,1);else if(o.events)for(var p=0,q=o.events.length;q>p;p++)o.events[p].rid===c&&o.events.splice(p,1)}}if(h)for(var k=0;k<j.length;k++)"COMPONENT"===j[k].clzType&&j[k].dataOpt&&j[k].dataOpt.submitMode&&(j[k].dataOpt.submitMode="IMMEDIATE");f.saveJsonVm(e)},_processFrom:function(){var a=this._getFormJson(),b=a.vuiRef.input;0==b.length&&this._deleteComp("comp-id-form"),this._responseFormChange()},_deleteCompFromForm:function(a){for(var b=this._getFormJson(),c=b.vuiRef.input,d=0,e=c.length;e>d;d++)if(c[d]==a){c.splice(d,1);break}},updateCompPositing:function(a,b,c){this.$reportVm.find("[data-comp-id="+a+"]").css({left:b,top:c}),this.saveJsonVm()},dateCompPositing:function(a,b){var c=this.$reportVm.find("[id="+a+"]");c.attr("id")==a&&c.html(b),this.saveJsonVm()},resizeComp:function(a){var b=this.$reportVm.find("[data-comp-id="+a.compId+"]"),c=71,d=b.find('[data-o_o-di="snpt.'+a.compId+'-vu-table-rich-select"]').length>0?!0:!1,e=b.find('[data-o_o-di="snpt.'+a.compId+'-vu-table-breadcrumb"]').length>0?!0:!1;d&&(c+=37),e&&(c+=18),b.css({width:a.width,height:a.height}).find(".vu-table").height(parseInt(a.height)-c),b.css({width:a.width,height:a.height}).find(".vu-plane-table").height(parseInt(a.height)-90),this.saveJsonVm()},saveReport:function(b,c,d){var e=this;$.ajax({url:a.saveReport(e.id),type:"PUT",data:{json:JSON.stringify(e.reportJson),vm:e.$reportVm.prop("outerHTML")},success:function(a){if(0===a.status)c&&c();else{var e=a.statusInfo;d&&d(e,b)}}})},saveJsonVm:function(b){var c=this;b=b||new Function,$.ajax({url:a.saveJsonVm(c.id),type:"PUT",data:{json:JSON.stringify(c.reportJson),vm:c.$reportVm.prop("outerHTML")},success:function(){b()}})},saveEditReportName:function(b,c){$.ajax({type:"POST",dataType:"json",cache:!1,timeout:1e4,uri:a.saveEditReportName(b,c),success:function(a){0===a.status?dialog.success(a.statusInfo):dialog.error(a.statusInfo)}})},getFixReportTaskMgrList:function(b,c){$.ajax({url:a.getFixReportTaskMgrList(b),type:"get",success:function(a){a.data&&a.data.length>0?c(!0):c(!1)}})}})});